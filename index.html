<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Que Timer</title>

<style>
:root{ color-scheme: dark; }
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:system-ui,-apple-system,"Hiragino Sans",sans-serif;
}
.wrap{ padding:16px; display:flex; flex-direction:column; gap:12px; min-height:100vh; box-sizing:border-box; }
h1{ margin:0 0 6px 0; font-size:22px; letter-spacing:.2px; }
.row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

button{
  font-size:16px;
  padding:10px 14px;
  border-radius:10px;
  border:1px solid #444;
  background:#111;
  color:#fff;
}
button.primary{ border-color:#888; }
button.admin{ border-color:#2a6; background:#083; }
button.danger{ border-color:#600; background:#200; }

.card{
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  background:#0b0b0b;
}

.label{ opacity:.7; font-size:13px; }
.val{ font-size:28px; font-variant-numeric:tabular-nums; margin-top:6px; }

textarea{
  width:100%;
  min-height:220px;
  background:#050505;
  color:#fff;
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  box-sizing:border-box;
  font-size:15px;
  line-height:1.5;
}
textarea::placeholder{ color:#9a9a9a; }

.small{ font-size:13px; opacity:.75; line-height:1.55; }

.overlay{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  padding:24px;
}
.big{
  font-size:min(18vw,120px);
  font-weight:800;
  text-align:center;
}
.signature{
  position:fixed;
  right:14px;
  bottom:12px;
  font-size:11px;
  letter-spacing:1.5px;
  opacity:.45;
  font-weight:500;
  pointer-events:none;
  user-select:none;
}

pre{
  margin:10px 0 0 0;
  padding:10px 12px;
  border:1px solid #2a2a2a;
  border-radius:10px;
  background:#070707;
  overflow:auto;
  white-space:pre-wrap;
}

.hidden{ display:none !important; }
</style>
</head>

<body>

<!-- ========== å…¥åŠ›ãƒšãƒ¼ã‚¸ï¼ˆåˆæœŸè¡¨ç¤ºï¼‰ ========== -->
<div id="screenEdit" class="wrap">
  <h1>Que Timer</h1>

  <div class="row">
    <button id="helpBtn">â“ ä½¿ã„æ–¹</button>
    <button id="copyBaseBtn">ğŸ  é€šå¸¸URLã‚’ã‚³ãƒ”ãƒ¼</button>
  </div>

  <div class="card">
    <div class="label">ã‚­ãƒ¥ãƒ¼å…¥åŠ›</div>
    <textarea id="cueText" placeholder="ã“ã“ã«ã‚­ãƒ¥ãƒ¼ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š7, â‘ ã‚’èµ·å‹•ï¼‰"></textarea>
    <div class="small" style="margin-top:10px;">
      ãƒ»å½¢å¼ï¼š<b>ç§’æ•°, æŒ‡ç¤º</b><br>
      ãƒ»å°æ•°OKï¼ˆä¾‹ï¼š18.5ï¼‰<br>
      ãƒ»# ã‹ã‚‰å§‹ã¾ã‚‹è¡Œã¯ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆç„¡è¦–ï¼‰
    </div>
  </div>

  <div class="row">
    <button id="toTimerBtn" class="primary">â–¶ ã‚¿ã‚¤ãƒãƒ¼ã¸ï¼ˆä¿å­˜ãªã—ï¼‰</button>
    <button id="copyViewBtn">ğŸ”— Copy linkï¼ˆé–²è¦§ï¼‰</button>
    <button id="saveAdminBtn" class="admin">ğŸ” ä¿å­˜ï¼ˆç®¡ç†è€…ãƒªãƒ³ã‚¯ç”Ÿæˆï¼‰</button>
  </div>

  <div class="card">
    <div class="label">ãƒ¡ãƒ¢</div>
    <div class="small">
      âœ… é€šå¸¸URLã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼ˆé–‹ãç›´ã™ã¨ç©ºã«ãªã‚Šã¾ã™ï¼‰ã€‚<br>
      âœ… ã€ŒCopy linkï¼ˆé–²è¦§ï¼‰ã€ã¯ <b>é–²è¦§å°‚ç”¨</b>ï¼ˆç·¨é›†ä¸å¯ï¼‰ã§ã™ã€‚<br>
      âœ… ã€Œä¿å­˜ã€ã¯<b>ç®¡ç†è€…ãƒªãƒ³ã‚¯</b>ã‚’ä½œã‚‹ã ã‘ã§ã™ã€‚<br>
      âœ… ç®¡ç†è€…ãƒªãƒ³ã‚¯ã‚’å…±æœ‰ã™ã‚Œã°ã€è¤‡æ•°äººã§åŒã˜ã‚­ãƒ¥ãƒ¼ã‚’ç·¨é›†ã§ãã¾ã™ã€‚
    </div>
  </div>
</div>

<!-- ========== ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ ========== -->
<div id="screenTimer" class="wrap hidden">
  <h1>Que Timer</h1>

  <div class="row">
    <button id="startBtn" class="primary">â–¶ Start</button>
    <button id="pauseBtn">â¸ Pause</button>
    <button id="resetBtn" class="danger">Reset</button>
    <button id="helpBtn2">â“ ä½¿ã„æ–¹</button>

    <!-- ç®¡ç†è€…ãƒªãƒ³ã‚¯ã®ã¿è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒãƒ¼ã‹ã‚‰ç·¨é›†ã¸æˆ»ã‚‹ï¼‰ -->
    <button id="backToEditBtn" class="hidden">âœ ç·¨é›†ã¸</button>

    <!-- ç®¡ç†è€…/é–²è¦§è€…ã©ã¡ã‚‰ã§ã‚‚æŠ¼ã›ã°ã€Œã‚­ãƒ¥ãƒ¼ç©ºã®å…¥åŠ›ãƒšãƒ¼ã‚¸ã€ã¸ -->
    <button id="backEmptyBtn">â† ã‚­ãƒ¥ãƒ¼å…¥åŠ›ã¸ï¼ˆä¿å­˜ãªã—ï¼‰</button>
  </div>

  <div class="card">
    <div class="label">çµŒéæ™‚é–“</div>
    <div class="val" id="elapsed">00:00.0</div>
  </div>

  <div class="card">
    <div class="label">æ¬¡ã®ã‚­ãƒ¥ãƒ¼ã¾ã§</div>
    <div class="val" id="toNext">--</div>
  </div>

  <div class="card">
    <div class="label">æ¬¡ã®ã‚­ãƒ¥ãƒ¼</div>
    <div class="val" id="nextCue">--</div>
  </div>

  <div class="card">
    <div class="label">ã“ã®ãƒªãƒ³ã‚¯ã®æ¨©é™</div>
    <div class="small" id="roleText">--</div>
  </div>
</div>

<!-- ========== ãƒ˜ãƒ«ãƒ—ç”»é¢ ========== -->
<div id="screenHelp" class="wrap hidden">
  <h1>Que Timer</h1>

  <div class="card">
    <p><b>å…¥åŠ›å½¢å¼ï¼š</b><br>
    ã€Œé–‹å§‹ã‹ã‚‰ã®ç§’æ•°, æŒ‡ç¤ºå†…å®¹ã€ã§å…¥åŠ›ã—ã¾ã™ã€‚</p>
    <p class="small">
      ãƒ»ç§’æ•°ã¯é–‹å§‹ã‹ã‚‰ã®çµ¶å¯¾ç§’<br>
      ãƒ»å°æ•°ä½¿ç”¨å¯ï¼ˆä¾‹ï¼š18.5ï¼‰<br>
      ãƒ»# ã§å§‹ã¾ã‚‹è¡Œã¯ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆç„¡è¦–ï¼‰
    </p>
  </div>

  <div class="card">
    <p><b>ä¾‹ï¼‘</b></p>
    <pre># ===== ä¾‹ï¼‘ =====

7, â‘ ã‚’èµ·å‹•
14, â‘¡ã‚’èµ·å‹•
18.5, â‘¢ã‚’èµ·å‹•</pre>
  </div>

  <div class="card">
    <p><b>ä¾‹ï¼’</b></p>
    <pre># ===== ä¾‹ï¼’ =====

5, ãƒ”ãƒ³C.I.
348, ãƒ”ãƒ³ãƒã‚¹ã‚¯ã‚¢ã‚¦ãƒˆ</pre>
  </div>

  <div class="card">
    <p><b>ãƒªãƒ³ã‚¯é‹ç”¨ï¼ˆé‡è¦ï¼‰</b></p>
    <p class="small">
      ãƒ»<b>é€šå¸¸URL</b>ï¼šä¿å­˜ãªã—ã€‚é–‹ãç›´ã™ã¨ã‚­ãƒ¥ãƒ¼ã¯ç©ºã€‚èª°ã§ã‚‚é–‹ã‘ã‚‹ã€‚<br>
      ãƒ»<b>é–²è¦§ãƒªãƒ³ã‚¯</b>ï¼ˆc=...ï¼‰ï¼šé–²è¦§ã®ã¿ï¼ˆã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œç”¨ / ç·¨é›†ä¸å¯ï¼‰ã€‚<br>
      ãƒ»<b>ç®¡ç†è€…ãƒªãƒ³ã‚¯</b>ï¼ˆc=...&owner=1ï¼‰ï¼šç·¨é›†å¯èƒ½ã€‚å…±æœ‰ã™ã‚Œã°è¤‡æ•°äººã§ç®¡ç†ã§ãã¾ã™ã€‚
    </p>
  </div>

  <button id="closeHelpBtn">â† æˆ»ã‚‹</button>
</div>

<div class="overlay" id="overlay">
  <div class="big" id="bigText"></div>
</div>

<div class="signature">CB Â· Que Timer</div>

<script>
const URL_PARAM = "c";
const OWNER_PARAM = "owner";
const SHOW_MS = 900;

const $ = (id) => document.getElementById(id);

const screenEdit = $("screenEdit");
const screenTimer = $("screenTimer");
const screenHelp = $("screenHelp");

const cueTextEl = $("cueText");

const helpBtn = $("helpBtn");
const helpBtn2 = $("helpBtn2");
const closeHelpBtn = $("closeHelpBtn");

const copyBaseBtn = $("copyBaseBtn");
const copyViewBtn = $("copyViewBtn");
const toTimerBtn = $("toTimerBtn");
const saveAdminBtn = $("saveAdminBtn");

const startBtn = $("startBtn");
const pauseBtn = $("pauseBtn");
const resetBtn = $("resetBtn");
const backToEditBtn = $("backToEditBtn");
const backEmptyBtn = $("backEmptyBtn");

const elapsedEl = $("elapsed");
const toNextEl = $("toNext");
const nextCueEl = $("nextCue");
const roleText = $("roleText");

const overlay = $("overlay");
const bigText = $("bigText");

let cues = [];
let running = false;
let startTime = 0;
let carried = 0;
let nextIndex = 0;
let rafId = null;
let showUntil = 0;

function toB64(str){ return btoa(unescape(encodeURIComponent(str))); }
function fromB64(b64){ return decodeURIComponent(escape(atob(b64))); }

function baseUrl(){
  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç„¡ã—ã®ã€Œé€šå¸¸URLã€
  return location.origin + location.pathname;
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    return ok;
  }
}

function show(which){
  screenEdit.classList.add("hidden");
  screenTimer.classList.add("hidden");
  screenHelp.classList.add("hidden");
  if(which === "edit") screenEdit.classList.remove("hidden");
  if(which === "timer") screenTimer.classList.remove("hidden");
  if(which === "help") screenHelp.classList.remove("hidden");
}

function parseCuesFromText(text){
  const lines = (text || "")
    .split(/\r?\n/)
    .map(s => s.trim())
    .filter(Boolean);

  const parsed = [];
  for(const line of lines){
    if(line.startsWith("#")) continue;
    const parts = line.split(",");
    const t = parseFloat(parts[0]);
    const label = parts.slice(1).join(",").trim();
    if(!isNaN(t) && label) parsed.push({ tSec: t, text: label });
  }
  parsed.sort((a,b)=>a.tSec-b.tSec);
  return parsed;
}

function fmt(ms){
  const s = ms/1000;
  const m = Math.floor(s/60);
  const sec = s - m*60;
  const si = Math.floor(sec);
  const d = Math.floor((sec-si)*10);
  return String(m).padStart(2,"0")+":"+String(si).padStart(2,"0")+"."+d;
}

function nowMs(){ return running ? carried + (performance.now() - startTime) : carried; }

function tick(){
  const e = nowMs();
  elapsedEl.textContent = fmt(e);

  const next = cues[nextIndex];
  if(next){
    const remain = next.tSec*1000 - e;
    toNextEl.textContent = remain>0 ? (remain/1000).toFixed(1) : "0.0";
    nextCueEl.textContent = next.tSec + "s : " + next.text;

    if(remain <= 0){
      bigText.textContent = next.text;
      overlay.style.display = "flex";
      showUntil = performance.now() + SHOW_MS;
      nextIndex++;
    }
  }else{
    toNextEl.textContent = "--";
    nextCueEl.textContent = "--";
  }

  if(overlay.style.display==="flex" && performance.now() >= showUntil){
    overlay.style.display = "none";
  }

  rafId = requestAnimationFrame(tick);
}

function startTimer(){
  if(!cues.length){
    alert("ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™ã€‚\nä¾‹ï¼š7, â‘ ã‚’èµ·å‹•");
    return;
  }
  running = true;
  startTime = performance.now();
  rafId = requestAnimationFrame(tick);
}

function pauseTimer(){
  if(!running) return;
  running = false;
  carried = nowMs();
  cancelAnimationFrame(rafId);
}

function resetTimer(){
  pauseTimer();
  carried = 0;
  nextIndex = 0;
  elapsedEl.textContent = "00:00.0";
  toNextEl.textContent = "--";
  nextCueEl.textContent = "--";
  overlay.style.display = "none";
}

function applyFromUrl(){
  const params = new URLSearchParams(location.search);
  const c = params.get(URL_PARAM);
  const isOwner = params.get(OWNER_PARAM) === "1";

  if(!c){
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç„¡ã—ã¯å…¥åŠ›ãƒšãƒ¼ã‚¸ï¼ˆã‚­ãƒ¥ãƒ¼ç©ºï¼‰
    cueTextEl.value = "";
    show("edit");
    return;
  }

  // ã‚¿ã‚¤ãƒãƒ¼ç”»é¢
  show("timer");

  // æ¨©é™è¡¨ç¤ºï¼†ç·¨é›†ãƒœã‚¿ãƒ³
  if(isOwner){
    roleText.innerHTML = "ğŸ” <b>ç®¡ç†è€…</b>ï¼ˆã“ã®ãƒªãƒ³ã‚¯ã‚’å…±æœ‰ã™ã‚‹ã¨è¤‡æ•°äººã§ç·¨é›†ã§ãã¾ã™ï¼‰";
    backToEditBtn.classList.remove("hidden");
  }else{
    roleText.innerHTML = "ğŸ‘ <b>é–²è¦§</b>ï¼ˆã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œã®ã¿ / ç·¨é›†ä¸å¯ï¼‰";
    backToEditBtn.classList.add("hidden");
  }

  // ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚­ãƒ¥ãƒ¼ç¢ºå®š
  let cueText = "";
  try{ cueText = fromB64(c); }catch{ cueText = ""; }
  cues = parseCuesFromText(cueText);
  resetTimer();
}

function goToTimerWith(text, ownerFlag){
  const u = new URL(baseUrl());
  u.searchParams.set(URL_PARAM, toB64(text || ""));
  if(ownerFlag) u.searchParams.set(OWNER_PARAM, "1");
  location.href = u.toString();
}

/* ====== UI wiring ====== */
helpBtn.onclick = () => show("help");
helpBtn2.onclick = () => show("help");

closeHelpBtn.onclick = () => {
  // URLçŠ¶æ…‹ã§æˆ»ã™
  applyFromUrl();
};

copyBaseBtn.onclick = async () => {
  const url = baseUrl();
  const ok = await copyToClipboard(url);
  if(!ok) alert(url);
};

copyViewBtn.onclick = async () => {
  const text = cueTextEl.value || "";
  if(!text.trim()){
    alert("ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™ã€‚\nä¾‹ï¼š7, â‘ ã‚’èµ·å‹•");
    return;
  }
  const u = new URL(baseUrl());
  u.searchParams.set(URL_PARAM, toB64(text));
  u.searchParams.delete(OWNER_PARAM);
  const ok = await copyToClipboard(u.toString());
  if(!ok) alert(u.toString());
};

toTimerBtn.onclick = () => {
  // ä¿å­˜ãªã—ï¼šé–²è¦§ãƒªãƒ³ã‚¯ã¨ã—ã¦ã‚¿ã‚¤ãƒãƒ¼ã¸é·ç§»
  const text = cueTextEl.value || "";
  if(!text.trim()){
    alert("ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™ã€‚\nä¾‹ï¼š7, â‘ ã‚’èµ·å‹•");
    return;
  }
  goToTimerWith(text, false);
};

saveAdminBtn.onclick = async () => {
  // ä¿å­˜ï¼ç®¡ç†è€…ãƒªãƒ³ã‚¯ç”Ÿæˆï¼šã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰ã€ãã®ãƒªãƒ³ã‚¯ã¸é·ç§»
  const text = cueTextEl.value || "";
  if(!text.trim()){
    alert("ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™ã€‚\nä¾‹ï¼š7, â‘ ã‚’èµ·å‹•");
    return;
  }
  const u = new URL(baseUrl());
  u.searchParams.set(URL_PARAM, toB64(text));
  u.searchParams.set(OWNER_PARAM, "1");
  await copyToClipboard(u.toString());
  location.href = u.toString();
};

startBtn.onclick = startTimer;
pauseBtn.onclick = pauseTimer;
resetBtn.onclick = resetTimer;

backToEditBtn.onclick = () => {
  // ç®¡ç†è€…ãƒªãƒ³ã‚¯ã‹ã‚‰ã®ã¿ï¼šç·¨é›†ãƒšãƒ¼ã‚¸ã¸æˆ»ã™ï¼ˆURLã®ã‚­ãƒ¥ãƒ¼ã‚’å…¥åŠ›æ¬„ã¸å¾©å…ƒï¼‰
  show("edit");
  const params = new URLSearchParams(location.search);
  const c = params.get(URL_PARAM);
  if(c){
    try{ cueTextEl.value = fromB64(c); }catch{}
  }
};

backEmptyBtn.onclick = () => {
  // ç®¡ç†è€…/é–²è¦§è€…ã©ã¡ã‚‰ã§ã‚‚ï¼šã‚­ãƒ¥ãƒ¼ç©ºã®å…¥åŠ›ãƒšãƒ¼ã‚¸ã¸
  location.href = baseUrl();
};

/* ====== Boot ====== */
applyFromUrl();
</script>

</body>
</html>

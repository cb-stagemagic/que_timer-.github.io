<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Que Timer</title>

<style>
:root{ color-scheme: dark; }
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:system-ui,-apple-system,"Hiragino Sans",sans-serif;
}
.wrap{
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:100vh;
  box-sizing:border-box;
}
h1{ margin:0 0 6px 0; font-size:22px; letter-spacing:.2px; }
.row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

button{
  font-size:16px;
  padding:10px 14px;
  border-radius:10px;
  border:1px solid #444;
  background:#111;
  color:#fff;
}
button.primary{ border-color:#888; }
button.admin{ border-color:#2a6; background:#083; }
button.danger{ border-color:#600; background:#200; }

.card{
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  background:#0b0b0b;
}
.label{ opacity:.7; font-size:13px; }
.val{ font-size:28px; font-variant-numeric:tabular-nums; margin-top:6px; }

textarea{
  width:100%;
  min-height:240px;
  background:#050505;
  color:#fff;
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  box-sizing:border-box;
  font-size:15px;
  line-height:1.5;
}
textarea::placeholder{ color:#9a9a9a; }

.small{ font-size:13px; opacity:.75; line-height:1.55; }

.overlay{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  padding:24px;
}
.big{
  font-size:min(18vw,120px);
  font-weight:800;
  text-align:center;
}

#cueList div{
  padding:4px 6px;
  border-radius:6px;
}
#cueList .active{
  background:#553;
  color:#ff0;
}
#cueList .done{
  opacity:.4;
}

pre{
  margin:10px 0 0 0;
  padding:10px 12px;
  border:1px solid #2a2a2a;
  border-radius:10px;
  background:#070707;
  overflow:auto;
  white-space:pre-wrap;
}

.signature{
  position:fixed;
  right:14px;
  bottom:12px;
  font-size:11px;
  letter-spacing:1.5px;
  opacity:.45;
  pointer-events:none;
}

.hidden{ display:none !important; }
</style>
</head>

<body>

<!-- ===== ç¬¬1ç”»é¢ï¼šå…¥åŠ› ===== -->
<div id="screenEdit" class="wrap">
  <h1>Que Timer</h1>

  <div class="row">
    <button id="helpBtn">â“ ä½¿ã„æ–¹</button>
    <button id="saveAdminBtn" class="admin">ğŸ” ä¿å­˜ï¼ˆç®¡ç†è€…ãƒªãƒ³ã‚¯ç”Ÿæˆï¼‰</button>
  </div>

  <div class="card">
    <div class="label">ã‚­ãƒ¥ãƒ¼å…¥åŠ›</div>
    <textarea id="cueText" placeholder="ã“ã“ã«ã‚­ãƒ¥ãƒ¼ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š7, â‘ ã‚’èµ·å‹•ï¼‰"></textarea>
  </div>
</div>

<!-- ===== ç¬¬2ç”»é¢ï¼šã‚¿ã‚¤ãƒãƒ¼ ===== -->
<div id="screenTimer" class="wrap hidden">
  <h1>Que Timer</h1>

  <div class="row">
    <button id="startBtn" class="primary">â–¶ Start</button>
    <button id="pauseBtn">â¸ Pause</button>
    <button id="resetBtn" class="danger">Reset</button>
    <button id="helpBtn2">â“ ä½¿ã„æ–¹</button>

    <button id="copyViewBtn" class="hidden">ğŸ”— é–²è¦§ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
    <button id="backToEditBtn" class="hidden">âœ ç·¨é›†ã¸</button>
    <button id="backEmptyBtn" class="hidden">â† ã‚­ãƒ¥ãƒ¼å…¥åŠ›ã¸</button>
  </div>

  <div class="card">
    <div class="label">çµŒéæ™‚é–“</div>
    <div class="val" id="elapsed">00:00.0</div>
  </div>

  <div class="card">
    <div class="label">æ¬¡ã®ã‚­ãƒ¥ãƒ¼ã¾ã§</div>
    <div class="val" id="toNext">--</div>
  </div>

  <div class="card">
    <div class="label">æ¬¡ã®ã‚­ãƒ¥ãƒ¼</div>
    <div class="val" id="nextCue">--</div>
  </div>

  <div class="card">
    <div class="label">ã‚­ãƒ¥ãƒ¼ä¸€è¦§</div>
    <div id="cueList" class="small"></div>
  </div>

  <div class="card">
    <div class="label">ã“ã®ãƒªãƒ³ã‚¯ã®æ¨©é™</div>
    <div class="small" id="roleText">--</div>
  </div>
</div>

<!-- ===== ãƒ˜ãƒ«ãƒ—ç”»é¢ ===== -->
<div id="screenHelp" class="wrap hidden">
  <h1>Que Timer</h1>

  <div class="card">
    <div class="label">å…¥åŠ›å½¢å¼</div>
    <div class="small">
      ã€Œé–‹å§‹ã‹ã‚‰ã®ç§’æ•°, æŒ‡ç¤ºå†…å®¹ã€<br>
      ãƒ»å°æ•°OKï¼ˆä¾‹ï¼š18.5ï¼‰<br>
      ãƒ»# ã§å§‹ã¾ã‚‹è¡Œã¯ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆç„¡è¦–ï¼‰
    </div>
  </div>

  <div class="card">
    <div class="label">ä¾‹ï¼‘</div>
    <pre># ===== ä¾‹ï¼‘ =====

7, â‘ ã‚’èµ·å‹•
14, â‘¡ã‚’èµ·å‹•
18.5, â‘¢ã‚’èµ·å‹•</pre>
  </div>

  <div class="card">
    <div class="label">ä¾‹ï¼’</div>
    <pre># ===== ä¾‹ï¼’ =====

5, ãƒ”ãƒ³C.I.
348, ãƒ”ãƒ³ãƒã‚¹ã‚¯ã‚¢ã‚¦ãƒˆ</pre>
  </div>

  <div class="card">
    <div class="label">ãƒªãƒ³ã‚¯é‹ç”¨</div>
    <div class="small">
      ãƒ»é€šå¸¸URLï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç„¡ã—ã€‚é–‹ãç›´ã™ã¨ã‚­ãƒ¥ãƒ¼ã¯ç©ºã€‚<br>
      ãƒ»é–²è¦§ãƒªãƒ³ã‚¯ï¼ˆc=...ï¼‰ï¼šé–²è¦§ã®ã¿ï¼ˆå®Ÿè¡Œç”¨ï¼‰<br>
      ãƒ»ç®¡ç†è€…ãƒªãƒ³ã‚¯ï¼ˆc=...&owner=1ï¼‰ï¼šç·¨é›†å¯èƒ½ï¼ˆå…±æœ‰ã™ã‚Œã°è¤‡æ•°äººã§ç®¡ç†ï¼‰
    </div>
  </div>

  <button id="closeHelpBtn">â† æˆ»ã‚‹</button>
</div>

<div class="overlay" id="overlay">
  <div class="big" id="bigText"></div>
</div>

<div class="signature">CB Â· Que Timer</div>

<script>
const URL_PARAM="c";
const OWNER_PARAM="owner";
const SHOW_MS=900;

const $=id=>document.getElementById(id);

const screenEdit=$("screenEdit");
const screenTimer=$("screenTimer");
const screenHelp=$("screenHelp");

const cueTextEl=$("cueText");
const cueListEl=$("cueList");
const roleText=$("roleText");

const helpBtn=$("helpBtn");
const helpBtn2=$("helpBtn2");
const closeHelpBtn=$("closeHelpBtn");

const saveAdminBtn=$("saveAdminBtn");
const copyViewBtn=$("copyViewBtn");
const backToEditBtn=$("backToEditBtn");
const backEmptyBtn=$("backEmptyBtn");

const startBtn=$("startBtn");
const pauseBtn=$("pauseBtn");
const resetBtn=$("resetBtn");

const elapsedEl=$("elapsed");
const toNextEl=$("toNext");
const nextCueEl=$("nextCue");

const overlay=$("overlay");
const bigText=$("bigText");

let cues=[],running=false,startTime=0,carried=0;
let nextIndex=0,rafId=null,showUntil=0;

// ãƒ˜ãƒ«ãƒ—ã‹ã‚‰æˆ»ã‚‹å…ˆï¼ˆ"edit" or "timer"ï¼‰
let lastScreen="edit";

function toB64(str){return btoa(unescape(encodeURIComponent(str)));}
function fromB64(b64){return decodeURIComponent(escape(atob(b64)));}

function baseUrl(){return location.origin+location.pathname;}

async function copy(text){
  try{ await navigator.clipboard.writeText(text); }
  catch{ alert(text); }
}

function show(which){
  screenEdit.classList.add("hidden");
  screenTimer.classList.add("hidden");
  screenHelp.classList.add("hidden");
  if(which==="edit") screenEdit.classList.remove("hidden");
  if(which==="timer") screenTimer.classList.remove("hidden");
  if(which==="help") screenHelp.classList.remove("hidden");
}

function parse(text){
  const arr=[];
  (text||"").split(/\n/).forEach(l=>{
    const line=(l||"").trim();
    if(!line || line.startsWith("#")) return;
    const p=line.split(",");
    const t=parseFloat(p[0]);
    const label=p.slice(1).join(",").trim();
    if(!isNaN(t) && label) arr.push({tSec:t,text:label});
  });
  return arr.sort((a,b)=>a.tSec-b.tSec);
}

function renderList(){
  cueListEl.innerHTML="";
  cues.forEach((c,i)=>{
    const d=document.createElement("div");
    d.textContent=c.tSec+"s  "+c.text;
    if(i<nextIndex) d.classList.add("done");
    else if(i===nextIndex) d.classList.add("active");
    cueListEl.appendChild(d);
  });
}

function fmt(ms){
  const s=ms/1000;
  const m=Math.floor(s/60);
  const sec=s-m*60;
  const si=Math.floor(sec);
  const d=Math.floor((sec-si)*10);
  return String(m).padStart(2,"0")+":"+String(si).padStart(2,"0")+"."+d;
}

function nowMs(){ return running ? carried + (performance.now()-startTime) : carried; }

function tick(){
  const e=nowMs();
  elapsedEl.textContent=fmt(e);

  const next=cues[nextIndex];
  if(next){
    const remainMs = next.tSec*1000 - e;
    const remainSec = Math.max(0, remainMs/1000);
    toNextEl.textContent = remainSec.toFixed(1);
    nextCueEl.textContent = next.tSec+"s : "+next.text;

    if(remainMs<=0){
      bigText.textContent=next.text;
      overlay.style.display="flex";
      showUntil=performance.now()+SHOW_MS;
      nextIndex++;
      renderList();
    }
  }else{
    toNextEl.textContent="--";
    nextCueEl.textContent="--";
  }

  if(overlay.style.display==="flex" && performance.now()>=showUntil){
    overlay.style.display="none";
  }

  rafId=requestAnimationFrame(tick);
}

function startTimer(){
  if(!cues.length){ alert("ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™"); return; }
  if(running) return;
  running=true;
  startTime=performance.now();
  rafId=requestAnimationFrame(tick);
}

function pauseTimer(){
  if(!running) return;
  running=false;
  carried=nowMs();
  cancelAnimationFrame(rafId);
}

function resetTimer(){
  pauseTimer();
  carried=0;
  nextIndex=0;
  elapsedEl.textContent="00:00.0";
  toNextEl.textContent="--";
  nextCueEl.textContent="--";
  overlay.style.display="none";
  renderList();
}

function applyFromUrl(){
  const params=new URLSearchParams(location.search);
  const c=params.get(URL_PARAM);
  const isOwner=params.get(OWNER_PARAM)==="1";

  if(!c){
    lastScreen="edit";
    show("edit");
    return;
  }

  lastScreen="timer";
  show("timer");

  if(isOwner){
    roleText.innerHTML="ğŸ” ç®¡ç†è€…";
    backToEditBtn.classList.remove("hidden");
    copyViewBtn.classList.remove("hidden");
    backEmptyBtn.classList.remove("hidden"); // ç®¡ç†è€…ã ã‘
  }else{
    roleText.innerHTML="ğŸ‘ é–²è¦§";
    backToEditBtn.classList.add("hidden");
    copyViewBtn.classList.add("hidden");
    backEmptyBtn.classList.add("hidden"); // é–²è¦§è€…ã¯éè¡¨ç¤º
  }

  cues=parse(fromB64(c));
  resetTimer();
}

/* ===== ãƒœã‚¿ãƒ³å‹•ä½œ ===== */
helpBtn.onclick=()=>{ lastScreen="edit"; show("help"); };
helpBtn2.onclick=()=>{ lastScreen="timer"; show("help"); };
closeHelpBtn.onclick=()=>{ show(lastScreen); };

saveAdminBtn.onclick=async()=>{
  const text=cueTextEl.value||"";
  if(!text.trim()){ alert("ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™"); return; }
  const u=new URL(baseUrl());
  u.searchParams.set(URL_PARAM,toB64(text));
  u.searchParams.set(OWNER_PARAM,"1");
  await copy(u.toString());
  location.href=u.toString();
};

copyViewBtn.onclick=async()=>{
  const params=new URLSearchParams(location.search);
  const c=params.get(URL_PARAM);
  if(!c) return;
  const u=new URL(baseUrl());
  u.searchParams.set(URL_PARAM,c); // ownerç„¡ã—=é–²è¦§
  await copy(u.toString());
};

backToEditBtn.onclick=()=>{
  lastScreen="edit";
  show("edit");
  cueTextEl.value=fromB64(new URLSearchParams(location.search).get(URL_PARAM)||"");
};

backEmptyBtn.onclick=()=>location.href=baseUrl();

startBtn.onclick=startTimer;
pauseBtn.onclick=pauseTimer;
resetBtn.onclick=resetTimer;

/* ===== èµ·å‹• ===== */
applyFromUrl();
</script>
</body>
</html>

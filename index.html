<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Que Timer</title>

<style>
:root{ color-scheme: dark; }
body{ margin:0; background:#000; color:#fff;
font-family:system-ui,-apple-system,"Hiragino Sans",sans-serif;}
.wrap{ padding:16px; display:flex; flex-direction:column;
gap:12px; min-height:100vh; box-sizing:border-box;}
h1{ margin:0 0 6px 0; font-size:22px;}
.row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
button{
font-size:16px; padding:10px 14px;
border-radius:10px; border:1px solid #444;
background:#111; color:#fff;}
button.primary{ border-color:#888;}
button.admin{ border-color:#2a6; background:#083;}
button.danger{ border-color:#600; background:#200;}

.card{ border:1px solid #333; border-radius:12px;
padding:12px; background:#0b0b0b;}
.label{ opacity:.7; font-size:13px;}
.val{ font-size:28px; font-variant-numeric:tabular-nums; margin-top:6px;}

textarea{
width:100%; min-height:240px;
background:#050505; color:#fff;
border:1px solid #333; border-radius:12px;
padding:12px; box-sizing:border-box;
font-size:15px; line-height:1.5;}

.small{ font-size:13px; opacity:.75; line-height:1.55;}

.overlay{ position:fixed; inset:0; background:#000;
display:none; align-items:center; justify-content:center;}
.big{ font-size:min(18vw,120px); font-weight:800;}

#cueList div{ padding:4px 6px; border-radius:6px;}
#cueList .active{ background:#553; color:#ff0;}
#cueList .done{ opacity:.4;}

.signature{
position:fixed; right:14px; bottom:12px;
font-size:11px; letter-spacing:1.5px;
opacity:.45; pointer-events:none;}

.hidden{ display:none !important;}
</style>
</head>

<body>

<!-- å…¥åŠ›ç”»é¢ -->
<div id="screenEdit" class="wrap">
<h1>Que Timer</h1>

<div class="row">
<button id="helpBtn">â“ ä½¿ã„æ–¹</button>
<button id="saveAdminBtn" class="admin">ğŸ” ä¿å­˜ï¼ˆç®¡ç†è€…ãƒªãƒ³ã‚¯ç”Ÿæˆï¼‰</button>
</div>

<div class="card">
<div class="label">ã‚­ãƒ¥ãƒ¼å…¥åŠ›</div>
<textarea id="cueText" placeholder="ã“ã“ã«ã‚­ãƒ¥ãƒ¼ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š7, â‘ ã‚’èµ·å‹•ï¼‰"></textarea>
</div>
</div>

<!-- ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ -->
<div id="screenTimer" class="wrap hidden">
<h1>Que Timer</h1>

<div class="row">
<button id="startBtn" class="primary">â–¶ Start</button>
<button id="pauseBtn">â¸ Pause</button>
<button id="resetBtn" class="danger">Reset</button>
<button id="helpBtn2">â“ ä½¿ã„æ–¹</button>
<button id="copyViewBtn" class="hidden">ğŸ”— é–²è¦§ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
<button id="backToEditBtn" class="hidden">âœ ç·¨é›†ã¸</button>
<button id="backEmptyBtn">â† ã‚­ãƒ¥ãƒ¼å…¥åŠ›ã¸</button>
</div>

<div class="card">
<div class="label">çµŒéæ™‚é–“</div>
<div class="val" id="elapsed">00:00.0</div>
</div>

<div class="card">
<div class="label">æ¬¡ã®ã‚­ãƒ¥ãƒ¼</div>
<div class="val" id="nextCue">--</div>
</div>

<div class="card">
<div class="label">ã‚­ãƒ¥ãƒ¼ä¸€è¦§</div>
<div id="cueList" class="small"></div>
</div>

<div class="card">
<div class="label">ã“ã®ãƒªãƒ³ã‚¯ã®æ¨©é™</div>
<div class="small" id="roleText">--</div>
</div>
</div>

<div class="overlay" id="overlay">
<div class="big" id="bigText"></div>
</div>

<div class="signature">CB Â· Que Timer</div>

<script>
const URL_PARAM="c";
const OWNER_PARAM="owner";
const SHOW_MS=900;
const $=id=>document.getElementById(id);

const screenEdit=$("screenEdit");
const screenTimer=$("screenTimer");
const cueTextEl=$("cueText");
const cueListEl=$("cueList");
const roleText=$("roleText");
const copyViewBtn=$("copyViewBtn");

let cues=[], running=false, startTime=0, carried=0;
let nextIndex=0, rafId=null, showUntil=0;

function toB64(str){return btoa(unescape(encodeURIComponent(str)));}
function fromB64(b64){return decodeURIComponent(escape(atob(b64)));}

function baseUrl(){return location.origin+location.pathname;}

async function copy(text){
try{await navigator.clipboard.writeText(text);}
catch{alert(text);}
}

function show(edit){
screenEdit.classList.toggle("hidden",!edit);
screenTimer.classList.toggle("hidden",edit);
}

function parse(text){
const arr=[];
(text||"").split(/\n/).forEach(l=>{
if(!l.trim()||l.startsWith("#"))return;
const p=l.split(",");
const t=parseFloat(p[0]);
if(!isNaN(t)&&p[1])arr.push({tSec:t,text:p.slice(1).join(",").trim()});
});
return arr.sort((a,b)=>a.tSec-b.tSec);
}

function renderList(){
cueListEl.innerHTML="";
cues.forEach((c,i)=>{
const d=document.createElement("div");
d.textContent=c.tSec+"s  "+c.text;
if(i<nextIndex)d.classList.add("done");
else if(i===nextIndex)d.classList.add("active");
cueListEl.appendChild(d);
});
}

function applyFromUrl(){
const params=new URLSearchParams(location.search);
const c=params.get(URL_PARAM);
const isOwner=params.get(OWNER_PARAM)==="1";

if(!c){ show(true); return; }

show(false);

if(isOwner){
roleText.innerHTML="ğŸ” ç®¡ç†è€…";
$("backToEditBtn").classList.remove("hidden");
copyViewBtn.classList.remove("hidden");
}else{
roleText.innerHTML="ğŸ‘ é–²è¦§";
$("backToEditBtn").classList.add("hidden");
copyViewBtn.classList.add("hidden");
}

cues=parse(fromB64(c));
renderList();
}

$("saveAdminBtn").onclick=async()=>{
const text=cueTextEl.value;
if(!text.trim()){alert("ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™");return;}
const u=new URL(baseUrl());
u.searchParams.set(URL_PARAM,toB64(text));
u.searchParams.set(OWNER_PARAM,"1");
await copy(u.toString());
location.href=u.toString();
};

copyViewBtn.onclick=async()=>{
const params=new URLSearchParams(location.search);
const c=params.get(URL_PARAM);
if(!c)return;
const u=new URL(baseUrl());
u.searchParams.set(URL_PARAM,c);
await copy(u.toString());
};

$("backToEditBtn").onclick=()=>{
show(true);
cueTextEl.value=fromB64(new URLSearchParams(location.search).get(URL_PARAM)||"");
};

$("backEmptyBtn").onclick=()=>location.href=baseUrl();

applyFromUrl();
</script>
</body>
</html>

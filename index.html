<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Que Timer</title>

<style>
:root{ color-scheme: dark; }
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:system-ui,-apple-system,"Hiragino Sans",sans-serif;
}
.wrap{ padding:16px; display:flex; flex-direction:column; gap:12px; }
h1{
  margin:0 0 6px 0;
  font-size:22px;
  letter-spacing:0.2px;
}
button{
  font-size:16px;
  padding:10px 14px;
  border-radius:10px;
  border:1px solid #444;
  background:#111;
  color:#fff;
}
button.primary{ border-color:#888; }
button.danger{ border-color:#600; background:#200; }
button.admin{ border-color:#2a6; background:#083; }

.card{
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  background:#0b0b0b;
}

.label{ opacity:.7; font-size:13px; }
.val{ font-size:28px; font-variant-numeric:tabular-nums; }

textarea{
  width:100%;
  min-height:160px;
  background:#050505;
  color:#fff;
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  box-sizing:border-box;
  font-size:15px;
  line-height:1.5;
}
textarea::placeholder{
  color:#9a9a9a;
}

.overlay{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
}
.big{
  font-size:min(18vw,120px);
  font-weight:800;
  text-align:center;
}
.sub{
  position:fixed;
  bottom:16px;
  left:0;
  right:0;
  text-align:center;
  font-size:18px;
  opacity:.8;
}
.signature{
  position:fixed;
  right:14px;
  bottom:12px;
  font-size:11px;
  letter-spacing:1.5px;
  opacity:.45;
  font-weight:500;
  pointer-events:none;
  user-select:none;
}
pre{
  margin:10px 0 0 0;
  padding:10px 12px;
  border:1px solid #2a2a2a;
  border-radius:10px;
  background:#070707;
  overflow:auto;
  white-space:pre-wrap;
}
.small-note{ font-size:13px; opacity:.8; }
</style>
</head>

<body>

<!-- ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ -->
<div id="screenTimer" class="wrap">
  <h1>Que Timer</h1>

  <div>
    <button id="startBtn" class="primary">â–¶ Start</button>
    <button id="pauseBtn">â¸ Pause</button>
    <button id="resetBtn" class="danger">Reset</button>
    <button id="copyViewBtn">ğŸ”— Copy linkï¼ˆé–²è¦§ï¼‰</button>
    <button id="copyAdminBtn" class="admin">ğŸ” Copy linkï¼ˆç®¡ç†è€…ï¼‰</button>
    <button id="helpBtn">â“ ä½¿ã„æ–¹</button>
  </div>

  <div class="card">
    <div class="label">çµŒéæ™‚é–“</div>
    <div class="val" id="elapsed">00:00.0</div>
  </div>

  <div class="card">
    <div class="label">æ¬¡ã®ã‚­ãƒ¥ãƒ¼ã¾ã§</div>
    <div class="val" id="toNext">--</div>
  </div>

  <div class="card">
    <div class="label">æ¬¡ã®ã‚­ãƒ¥ãƒ¼</div>
    <div class="val" id="nextCue">--</div>
  </div>

  <div class="card">
    <div class="label">ã‚­ãƒ¥ãƒ¼å…¥åŠ›</div>
    <textarea id="cueText" placeholder="ã“ã“ã«ã‚­ãƒ¥ãƒ¼ã‚’å…¥åŠ›"></textarea>
  </div>

  <!-- ç®¡ç†è€…ã®ã¿è¡¨ç¤º -->
  <div class="card" id="adminSaveCard" style="display:none;">
    <div class="label">ç®¡ç†è€…ä¿å­˜</div>
    <button id="saveBtn" class="primary">ğŸ’¾ ä¿å­˜ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</button>
    <div class="small-note">â€» ç®¡ç†è€…ãƒªãƒ³ã‚¯ï¼ˆowner=1ï¼‰ã§é–‹ã„ãŸå ´åˆã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
  </div>
</div>

<!-- ãƒ˜ãƒ«ãƒ—ç”»é¢ -->
<div id="screenHelp" class="wrap" style="display:none;">
  <h1>Que Timer</h1>

  <div class="card">
    <p><b>å…¥åŠ›å½¢å¼ï¼š</b><br>
    ã€Œé–‹å§‹ã‹ã‚‰ã®ç§’æ•°, æŒ‡ç¤ºå†…å®¹ã€ã§å…¥åŠ›ã—ã¾ã™ã€‚</p>

    <p>ãƒ»ç§’æ•°ã¯é–‹å§‹ã‹ã‚‰ã®çµ¶å¯¾ç§’<br>
    ãƒ»å°æ•°ä½¿ç”¨å¯èƒ½ï¼ˆä¾‹ï¼š12.5ï¼‰<br>
    ãƒ»# ã‚’å…ˆé ­ã«æ›¸ãã¨ã‚³ãƒ¡ãƒ³ãƒˆæ‰±ã„</p>
  </div>

  <div class="card">
    <p><b>ä¾‹ï¼‘</b></p>
    <pre># ===== ä¾‹ï¼‘ =====

7, â‘ ã‚’èµ·å‹•
14, â‘¡ã‚’èµ·å‹•
18.5, â‘¢ã‚’èµ·å‹•</pre>
  </div>

  <div class="card">
    <p><b>ä¾‹ï¼’</b></p>
    <pre># ===== ä¾‹ï¼’ =====

5, ãƒ”ãƒ³C.I.
348, ãƒ”ãƒ³ãƒã‚¹ã‚¯ã‚¢ã‚¦ãƒˆ</pre>
  </div>

  <div class="card">
    <p><b>ãƒªãƒ³ã‚¯ã®ç¨®é¡ï¼ˆé‡è¦ï¼‰</b></p>
    <p>
      ğŸ”— Copy linkï¼ˆé–²è¦§ï¼‰ï¼š<br>
      â†’ æ¼”ç›®ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®ãƒªãƒ³ã‚¯ã§ã™ã€‚<br>
      â†’ ä¿å­˜ãƒœã‚¿ãƒ³ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚<br><br>

      ğŸ” Copy linkï¼ˆç®¡ç†è€…ï¼‰ï¼š<br>
      â†’ ä½œæˆè€…ã®ã¿ä¿æŒã—ã¦ãã ã•ã„ã€‚<br>
      â†’ ä¿å­˜ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
      â†’ ã“ã®ãƒªãƒ³ã‚¯ã¯ä»–äººã«æ¸¡ã•ãªã„ã§ãã ã•ã„ã€‚
    </p>
  </div>

  <button id="backBtn">â† ã‚¿ã‚¤ãƒãƒ¼ã¸æˆ»ã‚‹</button>
</div>

<div class="overlay" id="overlay">
  <div class="big" id="bigText"></div>
  <div class="sub" id="subText"></div>
</div>

<div class="signature">CB Â· Que Timer</div>

<script>
const STORAGE_KEY="cueTimer.v5";
const URL_PARAM="c";
const OWNER_PARAM="owner";
const SHOW_MS=900;

const $=id=>document.getElementById(id);

const screenTimer=$("screenTimer");
const screenHelp=$("screenHelp");

const startBtn=$("startBtn");
const pauseBtn=$("pauseBtn");
const resetBtn=$("resetBtn");
const copyViewBtn=$("copyViewBtn");
const copyAdminBtn=$("copyAdminBtn");
const helpBtn=$("helpBtn");
const backBtn=$("backBtn");
const saveBtn=$("saveBtn");
const adminSaveCard=$("adminSaveCard");

const elapsedEl=$("elapsed");
const toNextEl=$("toNext");
const nextCueEl=$("nextCue");
const cueTextEl=$("cueText");

const overlay=$("overlay");
const bigText=$("bigText");
const subText=$("subText");

let cues=[],running=false,startTime=0,carried=0,nextIndex=0,rafId=null,showUntil=0;

function showHelp(){ screenTimer.style.display="none"; screenHelp.style.display="flex"; }
function showTimer(){ screenHelp.style.display="none"; screenTimer.style.display="flex"; }

helpBtn.onclick=showHelp;
backBtn.onclick=showTimer;

function toB64(str){ return btoa(unescape(encodeURIComponent(str))); }
function fromB64(b64){ return decodeURIComponent(escape(atob(b64))); }

function parseCues(){
  const raw = cueTextEl.value || "";
  const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const parsed=[];
  for(const line of lines){
    if(line.startsWith("#")) continue;
    const parts=line.split(",");
    const t=parseFloat(parts[0]);
    const text=parts.slice(1).join(",").trim();
    if(!isNaN(t) && text) parsed.push({tSec:t, text});
  }
  parsed.sort((a,b)=>a.tSec-b.tSec);
  cues=parsed;
}

function fmt(ms){
  const s=ms/1000;
  const m=Math.floor(s/60);
  const sec=s-m*60;
  const si=Math.floor(sec);
  const d=Math.floor((sec-si)*10);
  return String(m).padStart(2,"0")+":"+String(si).padStart(2,"0")+"."+d;
}

function nowMs(){ return running ? carried+(performance.now()-startTime) : carried; }

function tick(){
  const e=nowMs();
  elapsedEl.textContent=fmt(e);

  const next=cues[nextIndex];
  if(next){
    const remain=next.tSec*1000 - e;
    toNextEl.textContent = remain>0 ? (remain/1000).toFixed(1) : "0.0";
    nextCueEl.textContent = next.tSec + "s : " + next.text;

    if(remain<=0){
      bigText.textContent = next.text;
      overlay.style.display="flex";
      showUntil = performance.now() + SHOW_MS;
      nextIndex++;
    }
  }else{
    toNextEl.textContent="--";
    nextCueEl.textContent="--";
  }

  if(overlay.style.display==="flex" && performance.now()>=showUntil){
    overlay.style.display="none";
  }
  rafId=requestAnimationFrame(tick);
}

startBtn.onclick=()=>{
  parseCues();
  if(!cues.length){
    alert("ã‚­ãƒ¥ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nä¾‹ï¼š7, â‘ ã‚’èµ·å‹•");
    return;
  }
  running=true;
  startTime=performance.now();
  rafId=requestAnimationFrame(tick);
};

pauseBtn.onclick=()=>{
  running=false;
  carried=nowMs();
  cancelAnimationFrame(rafId);
};

resetBtn.onclick=()=>{
  running=false;
  carried=0;
  nextIndex=0;
  elapsedEl.textContent="00:00.0";
  toNextEl.textContent="--";
  nextCueEl.textContent="--";
  overlay.style.display="none";
  parseCues();
};

copyViewBtn.onclick=async()=>{
  const u=new URL(location.href);
  u.searchParams.set(URL_PARAM, toB64(cueTextEl.value || ""));
  u.searchParams.delete(OWNER_PARAM);
  await navigator.clipboard.writeText(u.toString());
};

copyAdminBtn.onclick=async()=>{
  const u=new URL(location.href);
  u.searchParams.set(URL_PARAM, toB64(cueTextEl.value || ""));
  u.searchParams.set(OWNER_PARAM,"1");
  await navigator.clipboard.writeText(u.toString());
};

// ç®¡ç†è€…åˆ¤å®š
const params=new URLSearchParams(location.search);
const isOwner=params.get(OWNER_PARAM)==="1";
if(isOwner){
  adminSaveCard.style.display="block";
}

saveBtn.onclick=()=>{
  alert("ç®¡ç†è€…ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰");
};

cueTextEl.oninput=()=>{
  if(isOwner){
    try{ localStorage.setItem(STORAGE_KEY, cueTextEl.value || ""); }catch{}
  }
};

// URLå„ªå…ˆ
const urlData=params.get(URL_PARAM);
if(urlData){
  try{
    cueTextEl.value = fromB64(urlData);
    if(isOwner){
      localStorage.setItem(STORAGE_KEY, cueTextEl.value || "");
    }
  }catch{}
}else{
  const saved=localStorage.getItem(STORAGE_KEY);
  if(saved) cueTextEl.value=saved;
}

parseCues();
</script>

</body>
</html>

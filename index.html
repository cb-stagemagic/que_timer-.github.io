<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Que Timer</title>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:system-ui,-apple-system,"Hiragino Sans",sans-serif;
}
.wrap{ padding:16px; display:flex; flex-direction:column; gap:14px; min-height:100vh; box-sizing:border-box;}
.topbar{ display:flex; justify-content:space-between; align-items:center;}
h1{ margin:0; font-size:22px; }
button{
  font-size:15px;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #444;
  background:#111;
  color:#fff;
}
button.primary{ border-color:#888;}
button.admin{ border-color:#2a6; background:#083;}
.card{
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  background:#0b0b0b;
}
textarea{
  width:100%;
  min-height:200px;
  background:#050505;
  color:#fff;
  border:1px solid #333;
  border-radius:10px;
  padding:10px;
  font-size:14px;
}
.small{ font-size:13px; opacity:.8; line-height:1.5;}
.error{ color:#f55; font-size:13px;}
.val{ font-size:28px; margin-top:6px;}
.overlay{
  position:fixed; inset:0; background:#000;
  display:none; align-items:center; justify-content:center;
}
.big{ font-size:min(18vw,120px); font-weight:800; text-align:center;}
.signature{
  position:fixed; right:14px; bottom:12px;
  font-size:11px; letter-spacing:1.5px;
  opacity:.45; pointer-events:none;
}
.hidden{ display:none !important;}
</style>
</head>

<body>

<!-- 第一画面 -->
<div id="screenEdit" class="wrap">
  <div class="topbar">
    <h1>Que Timer</h1>
    <button id="helpBtn">使い方</button>
  </div>

  <div class="card">
    <textarea id="cueText" placeholder="例：7, ①を起動"></textarea>
    <div class="small">
      ・形式：秒数, 指示<br>
      ・小数OK（例：18.5）<br>
      ・# から始まる行はコメント（無視）<br>
      ・保存ボタンを押してください（開き直すと空になります）。
    </div>
    <div id="errorMsg" class="error hidden"></div>
  </div>

  <button id="saveBtn" class="admin">保存（管理者リンク生成）</button>
</div>

<!-- 第二画面 -->
<div id="screenTimer" class="wrap hidden">
  <div class="topbar">
    <h1>Que Timer</h1>
    <div>
      <button id="helpBtn2">使い方</button>
      <button id="homeBtn">ホーム</button>
      <button id="editBtn" class="hidden">編集</button>
    </div>
  </div>

  <div class="card">
    <div class="small">キュー一覧</div>
    <div id="cueList" class="small"></div>
  </div>

  <div class="card">
    <div class="small">経過時間</div>
    <div id="elapsed" class="val">00:00.0</div>
  </div>

  <div class="card">
    <div class="small">次のキュー</div>
    <div id="nextCue" class="val">--</div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div id="bigText" class="big"></div>
</div>

<div class="signature">CB · Que Timer</div>

<script>
const URL_PARAM="c";
const OWNER_PARAM="owner";
const SHOW_MS=900;

const $=id=>document.getElementById(id);

const screenEdit=$("screenEdit");
const screenTimer=$("screenTimer");
const cueTextEl=$("cueText");
const errorMsg=$("errorMsg");
const saveBtn=$("saveBtn");
const helpBtn=$("helpBtn");
const helpBtn2=$("helpBtn2");
const homeBtn=$("homeBtn");
const editBtn=$("editBtn");

const cueList=$("cueList");
const elapsedEl=$("elapsed");
const nextCueEl=$("nextCue");
const overlay=$("overlay");
const bigText=$("bigText");

let cues=[];
let running=false,startTime=0,carried=0,nextIndex=0,rafId=null,showUntil=0;

function toB64(str){ return btoa(unescape(encodeURIComponent(str))); }
function fromB64(b64){ return decodeURIComponent(escape(atob(b64))); }

function validateCues(text){
  const lines=text.split(/\r?\n/);
  for(let i=0;i<lines.length;i++){
    const line=lines[i].trim();
    if(!line||line.startsWith("#")) continue;
    if(!line.includes(",")) return "形式エラー（カンマが必要） 行："+(i+1);
    const parts=line.split(",");
    const t=parseFloat(parts[0]);
    const label=parts.slice(1).join(",").trim();
    if(isNaN(t)) return "秒数が数値ではありません 行："+(i+1);
    if(!label) return "指示が空です 行："+(i+1);
  }
  return null;
}

function parseCues(text){
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const parsed=[];
  for(const line of lines){
    if(line.startsWith("#")) continue;
    const parts=line.split(",");
    parsed.push({tSec:parseFloat(parts[0]), text:parts.slice(1).join(",").trim()});
  }
  parsed.sort((a,b)=>a.tSec-b.tSec);
  return parsed;
}

function show(screen){
  screenEdit.classList.add("hidden");
  screenTimer.classList.add("hidden");
  if(screen==="edit") screenEdit.classList.remove("hidden");
  if(screen==="timer") screenTimer.classList.remove("hidden");
}

function renderCueList(){
  cueList.innerHTML=cues.map(c=>`${c.tSec}s , ${c.text}`).join("<br>");
}

function fmt(ms){
  const s=ms/1000;
  const m=Math.floor(s/60);
  const sec=s-m*60;
  const si=Math.floor(sec);
  const d=Math.floor((sec-si)*10);
  return String(m).padStart(2,"0")+":"+String(si).padStart(2,"0")+"."+d;
}

function nowMs(){ return running?carried+(performance.now()-startTime):carried;}

function tick(){
  const e=nowMs();
  elapsedEl.textContent=fmt(e);
  const next=cues[nextIndex];
  if(next){
    const remain=next.tSec*1000-e;
    nextCueEl.textContent=next.text;
    if(remain<=0){
      bigText.textContent=next.text;
      overlay.style.display="flex";
      showUntil=performance.now()+SHOW_MS;
      nextIndex++;
    }
  }
  if(overlay.style.display==="flex"&&performance.now()>=showUntil){
    overlay.style.display="none";
  }
  rafId=requestAnimationFrame(tick);
}

saveBtn.onclick=()=>{
  const text=cueTextEl.value.trim();
  if(!text){ errorMsg.textContent="キューが空です"; errorMsg.classList.remove("hidden"); return;}
  const err=validateCues(text);
  if(err){ errorMsg.textContent=err; errorMsg.classList.remove("hidden"); return;}
  errorMsg.classList.add("hidden");
  const u=new URL(location.origin+location.pathname);
  u.searchParams.set(URL_PARAM,toB64(text));
  u.searchParams.set(OWNER_PARAM,"1");
  navigator.clipboard.writeText(u.toString());
  location.href=u.toString();
};

homeBtn.onclick=()=> location.href=location.origin+location.pathname;
editBtn.onclick=()=> show("edit");

function boot(){
  const params=new URLSearchParams(location.search);
  const c=params.get(URL_PARAM);
  const isOwner=params.get(OWNER_PARAM)==="1";

  if(!c){ show("edit"); return;}

  cues=parseCues(fromB64(c));
  renderCueList();
  show("timer");

  if(isOwner) editBtn.classList.remove("hidden");

  running=true;
  startTime=performance.now();
  rafId=requestAnimationFrame(tick);
}

boot();
</script>

</body>
</html>

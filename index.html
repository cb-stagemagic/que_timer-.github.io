<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Que Timer</title>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:system-ui,-apple-system,sans-serif;
}
.wrap{ padding:16px; display:flex; flex-direction:column; gap:14px; min-height:100vh; box-sizing:border-box; }
h1{ margin:0; font-size:22px; }

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button{
  padding:10px 14px;
  border-radius:8px;
  border:1px solid #444;
  background:#111;
  color:#fff;
}
button.primary{ border-color:#888; }
button.admin{ background:#083; border-color:#2a6; }
button.danger{ background:#200; border-color:#600; }

.card{
  border:1px solid #333;
  border-radius:10px;
  padding:12px;
  background:#0b0b0b;
}

textarea{
  width:100%;
  min-height:200px;
  background:#050505;
  color:#fff;
  border:1px solid #333;
  border-radius:10px;
  padding:12px;
  box-sizing:border-box;
  font-size:15px;
}

.small{ font-size:13px; opacity:.8; }

.val{ font-size:28px; font-variant-numeric:tabular-nums; }

.hidden{ display:none !important; }

.signature{
  position:fixed;
  right:14px;
  bottom:12px;
  font-size:11px;
  letter-spacing:1.5px;
  opacity:.45;
}
</style>
</head>

<body>

<!-- ========== 第一画面（入力） ========== -->
<div id="screenEdit" class="wrap">

  <div class="topbar">
    <h1>Que Timer</h1>
    <button id="helpBtn">使い方</button>
  </div>

  <div class="card">
    <textarea id="cueText" placeholder="ここにキューを入力"></textarea>
  </div>

  <div class="small">
    ・形式：秒数, 指示<br>
    ・小数OK（例：18.5）<br>
    ・# から始まる行はコメント（無視）<br>
    ・保存ボタンを押してください（開き直すと空になります）
  </div>

  <button id="saveBtn" class="admin">保存（管理者リンク生成）</button>

</div>


<!-- ========== 第二画面（タイマー） ========== -->
<div id="screenTimer" class="wrap hidden">

  <div class="topbar">
    <h1>Que Timer</h1>
    <button id="helpBtn2">使い方</button>
  </div>

  <div>
    <button id="homeBtn">ホーム</button>
    <button id="editBtn" class="hidden">編集</button>
  </div>

  <div class="card">
    <div>経過時間</div>
    <div id="elapsed" class="val">00:00.0</div>
  </div>

  <div class="card">
    <div>次のキューまで</div>
    <div id="remain" class="val">--</div>
  </div>

  <div class="card">
    <div>次のキュー</div>
    <div id="nextCue">--</div>
  </div>

  <div class="card">
    <div>キュー一覧</div>
    <pre id="cueList"></pre>
  </div>

  <div>
    <button id="startBtn" class="primary">Start</button>
    <button id="pauseBtn">Pause</button>
    <button id="resetBtn" class="danger">Reset</button>
  </div>

</div>


<!-- ========== 使い方 ========== -->
<div id="screenHelp" class="wrap hidden">
  <h1>使い方</h1>

  <div class="card">
    入力形式：<br>
    秒数, 指示<br><br>
    例：<br>
    7, ①を起動<br>
    18.5, マスクアウト
  </div>

  <button id="closeHelpBtn">戻る</button>
</div>

<div class="signature">CB · Que Timer</div>

<script>
const URL_PARAM="c";
const OWNER_PARAM="owner";

const $=id=>document.getElementById(id);

const screenEdit=$("screenEdit");
const screenTimer=$("screenTimer");
const screenHelp=$("screenHelp");

const cueTextEl=$("cueText");
const cueListEl=$("cueList");

const saveBtn=$("saveBtn");
const homeBtn=$("homeBtn");
const editBtn=$("editBtn");

const startBtn=$("startBtn");
const pauseBtn=$("pauseBtn");
const resetBtn=$("resetBtn");

const helpBtn=$("helpBtn");
const helpBtn2=$("helpBtn2");
const closeHelpBtn=$("closeHelpBtn");

const elapsedEl=$("elapsed");
const remainEl=$("remain");
const nextCueEl=$("nextCue");

let cues=[];
let running=false;
let startTime=0;
let carried=0;
let nextIndex=0;
let rafId=null;

function toB64(s){return btoa(unescape(encodeURIComponent(s)));}
function fromB64(s){return decodeURIComponent(escape(atob(s)));}

function show(screen){
  screenEdit.classList.add("hidden");
  screenTimer.classList.add("hidden");
  screenHelp.classList.add("hidden");
  if(screen==="edit") screenEdit.classList.remove("hidden");
  if(screen==="timer") screenTimer.classList.remove("hidden");
  if(screen==="help") screenHelp.classList.remove("hidden");
}

function parseCues(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const arr=[];
  for(const line of lines){
    if(line.startsWith("#")) continue;
    const parts=line.split(",");
    if(parts.length<2) throw new Error("形式エラー："+line);
    const t=parseFloat(parts[0]);
    if(isNaN(t)) throw new Error("秒数エラー："+line);
    const label=parts.slice(1).join(",").trim();
    if(!label) throw new Error("指示が空："+line);
    arr.push({t,label});
  }
  arr.sort((a,b)=>a.t-b.t);
  return arr;
}

function fmt(ms){
  const s=ms/1000;
  const m=Math.floor(s/60);
  const sec=s-m*60;
  const si=Math.floor(sec);
  const d=Math.floor((sec-si)*10);
  return String(m).padStart(2,"0")+":"+String(si).padStart(2,"0")+"."+d;
}

function nowMs(){return running?carried+(performance.now()-startTime):carried;}

function tick(){
  const e=nowMs();
  elapsedEl.textContent=fmt(e);

  const next=cues[nextIndex];
  if(next){
    const remain=next.t*1000-e;
    remainEl.textContent=remain>0?(remain/1000).toFixed(1):"0.0";
    nextCueEl.textContent=next.t+"s : "+next.label;
    if(remain<=0) nextIndex++;
  }else{
    remainEl.textContent="--";
    nextCueEl.textContent="--";
  }
  rafId=requestAnimationFrame(tick);
}

saveBtn.onclick=()=>{
  const text=cueTextEl.value.trim();
  if(!text){alert("キューが空です");return;}
  try{
    parseCues(text);
  }catch(e){
    alert(e.message);
    return;
  }
  const url=new URL(location.origin+location.pathname);
  url.searchParams.set(URL_PARAM,toB64(text));
  url.searchParams.set(OWNER_PARAM,"1");
  navigator.clipboard.writeText(url.toString());
  location.href=url.toString();
};

homeBtn.onclick=()=>location.href=location.origin+location.pathname;

editBtn.onclick=()=>{
  show("edit");
  cueTextEl.value=fromB64(new URLSearchParams(location.search).get(URL_PARAM)||"");
};

startBtn.onclick=()=>{
  if(!cues.length){alert("キューなし");return;}
  running=true;
  startTime=performance.now();
  rafId=requestAnimationFrame(tick);
};
pauseBtn.onclick=()=>{running=false;carried=nowMs();cancelAnimationFrame(rafId);};
resetBtn.onclick=()=>{running=false;carried=0;nextIndex=0;};

helpBtn.onclick=()=>show("help");
helpBtn2.onclick=()=>show("help");
closeHelpBtn.onclick=()=>applyFromUrl();

function applyFromUrl(){
  const params=new URLSearchParams(location.search);
  const c=params.get(URL_PARAM);
  const isOwner=params.get(OWNER_PARAM)==="1";
  if(!c){show("edit");return;}
  cues=parseCues(fromB64(c));
  cueListEl.textContent=fromB64(c);
  if(isOwner) editBtn.classList.remove("hidden");
  show("timer");
}

applyFromUrl();
</script>

</body>
</html>
